
<template>
    <style>

    #fiscal > *{
        display: flex;
        flex-direction: column;
        width: 98%;
        margin-left: 10px;  
        margin-top: 10px;      
    }

    #fiscal > label{
        margin-left: 20px;
    }


    button{
        width: 98%;
    }



    </style>
  

    <h1>NFe Venda</h1>
        
    <div class="tab-bar">
        <div class="tab-item" id="tab-emitente" onclick="pictab(this)"> Emitente</div>
        <div class="tab-item" id="tab-fiscal" onclick="pictab(this)">Fiscal</div>
        <div class="tab-item" id="tab-pedido" onclick="pictab(this)">Pedido</div>
        <div class="tab-item" id="tab-cliente" onclick="pictab(this)">Cliente</div>            
        <div class="tab-item" id="tab-itens" onclick="pictab(this)">Itens</div>
        <div class="tab-item" id="tab-frete" onclick="pictab(this)">Frete</div>
        <div class="tab-item" id="tab-fatura" onclick="pictab(this)">Faturamento</div>
        <div class="tab-item" id="tab-export" onclick="pictab(this)">Arquivos</div>
    </div>
    
    <div class="tab-screen">        
        <div id="emitente" class="tab">
<!--                <h2>Emitente</h2>               -->
            <div id="C">
                <div class="inline">
                    <label> Razão Social *</label>
                    <input type="text" id="xNome" maxlength="60" />
                </div>
                <div class="inline">
                    <label> Nome Fantasia </label>
                    <input type="text" id="xFant" maxlength="60" />
                </div>    

                <div class="inline">
                    <label> Insc. Estadual </label>
                    <input type="text" id="IE" maxlength="15" onkeyup="valIE(this)"/>
                    <input type="hidden" id="IEST" >                
                    <label> Insc. Municipal </label>
                    <input type="text" id="IM" maxlength="15" onkeyup="valInt(this)"/>
                </div> 
                <div class="inline">
                    <label> Regime Trib. </label>
                    <select id="CRT" >
                        <option value="1" selected>Simples Nacional</option>
                        <option value="2" >Simples Nacional - excesso de sublimite de receita bruta</option>
                        <option value="3" >Regime Normal.</option>
                    </select>
                    <label> CNAE </label>
                    <input type="text" id="CNAE" maxlength="7" onkeyup="valInt(this)"/>                        
                </div>                                                       
            </div>
            <div id="C02" class="inline">
                
                <label> CNPJ </label>
                <input type="text" id="CNPJ" maxlength="18" onkeyup="valCNPJ(this)"/>
            </div>
            <div id="C05">
                <div class="inline">
                    <label> Endereço </label>
                    <input type="text" id="xLgr" maxlength="60" />
                    <label> Número: </label>
                    <input type="text" id="nro" maxlength="5" style="max-width: 100px;" />
                </div>
                <div class="inline">
                    <label> Bairro </label>
                    <input type="text" id="bairro" maxlength="60" />
                    <label> Complemento </label>
                    <input type="text" id="cpl" maxlength="60" style="max-width: 200px;" />
                </div>
                <div class="inline">
                    <label> Municipio</label>
                    <input type="text" id="xMun" maxlength="60" />
                    <label> Código</label>
                    <input type="text" id="cMun" maxlength="7" style="max-width: 150px;" onkeyup="valInt(this)" />
                    <label> Sigla da UF </label>
                    <input type="text" id="UF" maxlength="2" style="max-width: 50px;" />
                </div>
                <div class="inline">
                    <label> Nome do País </label>
                    <input type="text" id="xPais" maxlength="60" />
                    <label> Código </label>
                    <input type="text" id="cPais" maxlength="4" onkeyup="valInt(this)"/>
                </div>
                <div class="inline">
                    <label> CEP </label>
                    <input type="text" id="CEP" maxlength="10" onkeyup="valCEP(this)"/>
                    <label> Telefone </label>
                    <input type="text" id="fone" maxlength="14" onkeyup="phone(this)"/>
                </div>
            </div>
            <button id="btnSaveEmit">Salvar</button>
                            
        </div>            
        <div id="fiscal" class="tab">
<!--                <h2>Fiscal</h2>-->
        
            <div id="B">

                <input type="hidden" id="cUF" value="35">
                <input type="hidden" id="cNF">
                <input type="hidden" id="serie" value="1">
                <input type="hidden" id="cMunFG">
                <input type="hidden" id="cDV">
                <input type="hidden" id="verProc">
                <input type="hidden" id="dhCont">
                <input type="hidden" id="xJust">
            
                <label> Numero da NF</label>    
                <input type="text" id="nNF" maxlength="9" />

                <label> Nat. Operação *</label>
                <input type="text" id="natOp" maxlength="60" />

                <label> Código do Modelo do Documento Fiscal </label>
                <input type="text" id="mod" maxlength="2" value=""/>
                
                <label> Data de emissão do Documento Fiscal </label>
                <input type="date" id="dhEmi" value="" >

                <label> Data e hora de Saída ou da Entrada da Mercadoria/Produto </label>
                <input type="date" id="dhSaiEnt" value="">

                <label> Tipo de Operação</label>
                <select id="tpNF" >
                    <option value="0" selected>Entrada</option>
                    <option value="1">Saída</option>
                </select>

                <label> Identificador de Local de destino da operação</label>
                <select id="idDest" >
                    <option value="1">Operação Interna</option>
                    <option value="2">Operação Interestadual</option>
                    <option value="3">Operação com o Exterior</option>
                </select>
    
                <label> Formato de Impressão do DANFE</label>
                <select id="tpImp" >
                    <option value="1">Retrato</option>
                    <option value="2">Paisagem</option>
                </select>

                <label>Tipo de Emissão da NF-e</label>
                <select id="tpEmis" >
                    <option value="1">Normal</option>
                    <option value="2">Contingência FS - emissão em contingência com impressão do DANFE em Formulário de Segurança</option>
                    <option value="4">Contingência EPEC - emissão em contingência com envio da Evento Prévio de Emissão em Contingência - EPEC</option>
                    <option value="5">Contingência FS-DA - emissão em contingência com impressão do DANFE em Formulário de Segurança para Impressão de Documento Auxiliar de Documento Fiscal Eletrônico (FS-DA)</option>
                    <option value="6">Contingência SVC-AN</option>
                    <option value="7">Contingência SVC-RS</option>
                    <option value="9">Contingência off-line NFC-e</option>
                </select>
    
                <label> Identificação do Ambiente</label>
                <select id="tpAmb" >
                    <option value="1">Produção</option>
                    <option value="2">Homologação</option>
                </select>

                <label> Finalidade de emissão da NF-e</label>
                <select id="finNFe" >
                    <option value="1">NF-e normal</option>
                    <option value="2">NF-e complementar</option>
                    <option value="3">NF-e de ajuste</option>
                    <option value="4">Devolução de mercadoria</option>
                </select>

                <label>Indica operação com o consumidor final</label>
                <select id="indFinal" >
                    <option value="0">Normal</option>    
                    <option value="1">Consumidor Final</option>
                </select>

                <label>Indicador de presença do comprador no estabelecimento comercial no momento da operação</label>
                <select id="indPres" >
                    <option value="0">Não se aplica (por exemplo Nota Fiscal Complementar ou de ajuste)</option>
                    <option value="1">Operação presencial</option>
                    <option value="2">Operação não presencial, pela Internet</option>
                    <option value="3">Operação não presencial, pelo tele atendimento</option>
                    <option value="4">NFC-e em operação com entrega em domicílio</option>
                    <option value="5">Operação não presencial, fora do estabelecimento</option>
                    <option value="9">Operação não presencial, outros</option>
                </select>

                <label>Processo de emissão da NF-e</label>
                <select id="procEmi" >
                    <option value="" selected></option>
                    <option value="0">emissão de NF-e com aplicativo do contribuinte</option>
                    <option value="1">emissão de NF-e avulsa pelo Fisco</option>
                    <option value="2">emissão de NF-e avulsa, pelo contribuinte com seu certificado digital, através do site do Fisco</option>
                    <option value="3">emissão NF-e pelo contribuinte com aplicativo fornecido pelo Fisco</option>
                </select>
            </div>                

                <button id="btnSaveFiscal">Salvar</button>                
        </div>            
        <div id="pedido" class="tab">
<!--                <h2>Pedido</h2>-->

            <fieldset class="fds-busca nfe">
                <legend>Filtro</legend>
        
                <div class="inline">
                    <select id="cmbBusca">
                        <optgroup label="Geral">
                            <option value="id"     signal=">" val="0"   >Todos</option>                        
                            <option value="status"   signal="=" val="'COT'" >Cotações</option>
                            <option value="status"   signal="=" val="'PED'" selected>Pedidos</option>
                            <option value="status"   signal="=" val="'FAT'"   >Faturados  </option>
                            <option value="id"       signal="IN"   >Código</option>
                            <option value="num_ped"  signal="LIKE">Número</option>
                            <option value="id_prod"  signal="LIKE"  >Cod. do Produto</option>
                            <option value="EMPRESA"  signal="LIKE"   >Cliente</option>
                            <option value="id_emp"   signal="IN"   >Cod. do Cliente</option>      
                        </optgroup>
                    </select>
                    <div class="busca-itens">
                        <input type="text" id="edtBusca" placeholder="Digite sua Busca" onkeypress="return getEnter(event, 'btnBuscaPed')">
                        <button id="btnBuscaPed" class="btn-round"><span class="mdi mdi-magnify"></span></button>
                    </div>
                </div>
                <div class="inline">
                    <div class="line-ckb">
                        <label for="ckbData">Início/Final</label>
                        <input type="checkbox" id="ckbData" checked>
                    </div>
                    <input type="date" id="edtIni" onkeypress="return getEnter(event, 'btnBuscaPed')">
                    <input type="date" id="edtFin" onkeypress="return getEnter(event, 'btnBuscaPed')">
                </div>            
            </fieldset>
            <table id="tblBuscaPed"></table> 

        </div>
        <div id="cliente" class="tab">
<!--                <h2>Cliente</h2>-->
            <div id="E">
                <div class="inline">
                    <label> Razão Social *</label>
                    <input type="text" id="xNome" maxlength="60"/>
                </div>
                <div class="inline">
                    <label> ICMS</label>
                    <select id="indIEDest">
                        <option value="1">Contribuinte ICMS (informar a IE do destinatário)</option>
                        <option value="2">Contribuinte isento de Inscrição no cadastro de Contribuintes do ICMS (Não possui IE)</option>
                        <option value="9">Não Contribuinte, que pode ou não possuir Inscrição Estadual no Cadastro de Contribuintes do ICMS</option>
                    </select>
                </div>
                <div class="inline">
                    <label> Insc. Estadual </label>
                    <input type="text" id="IE" maxlength="15" onkeyup="valIE(this)"/>
                    <input type="hidden" id="ISUF">
                    <label> Insc. Municipal </label>
                    <input type="text" id="IM" maxlength="15" onkeyup="valInt(this)"/>                 
                </div>
                <div class="inline">
                    <label> Email </label>
                    <input type="text" id="email"/>
                </div>

            </div>                           
            <div id="E02" class="inline">
                <label> CNPJ </label>
                <input type="text" id="CNPJ" maxlength="18" onkeyup="valCNPJ(this)"/>
            </div>
            <div id="E05">
                <div class="inline">
                    <label> Endereço </label>
                    <input type="text" id="xLgr" maxlength="60"/>
                    <label> Número: </label>
                    <input type="text" id="nro" maxlength="5" style="width: 100px;" />    
                </div>
                <div class="inline">
                    <label> Bairro </label>
                    <input type="text" id="xBairro" maxlength="60"/>
                    <label> Complemento </label>
                    <input type="text" id="XCpl" maxlength="60"/>
                </div>
                <div class="inline">
                    <label>  Municipio</label>
                    <input type="text" id="xMun" maxlength="60"/>
                    <label> UF </label>
                    <input type="text" id="UF" maxlength="2" style="width: 70px ;"/>                      
                    <label> Cod.</label>
                    <input type="text" id="cMun" maxlength="7" onkeyup="valInt(this)" style="width: 200px ;" readonly/>
                    <button id="btnBuscaIBGE" class="btn-round"><span class="mdi mdi-magnify"></span></button>
                      
                </div>
                
                <div class="inline">
                    <label> País </label>
                    <input type="text" id="xPais" maxlength="15"/>                        
                    <label> Cod.</label>
                    <input type="text" id="cPais" maxlength="4"/>
                </div>
                <div class="inline">
                    <label> CEP </label>
                    <input type="text" id="CEP" maxlength="10" onkeyup="valCEP(this)"/>
                    <label> Telefone </label>
                    <input type="text" id="fone" maxlength="14" onkeyup="phone(this)"/>    
                </div>
            </div>
            <button id="btnSaveCli">Salvar</button>
        </div>        
        <div id="itens" class="tab">
            <table id="tblItens"></table>
        </div>
        <div id="frete" class="tab">
           <div class="inline">
                <label for="cmbModFrete">Modalidade</label>
                <select id="cmbModFrete">
                    <option value="0">Contratação do Frete por conta do Remetente (CIF)</option>
                    <option value="1">Contratação do Frete por conta do Destinatário (FOB)</option>
                    <option value="2">Contratação do Frete por conta de Terceiros</option>
                    <option value="3">Transporte Próprio por conta do Remetente</option>
                    <option value="4">Transporte Próprio por conta do Destinatário</option>
                    <option value="9">Sem ocorrência de transporte</option>
                </select>
           </div>
            <div class="inline">
                <label for="edtXNome">Transportadora</label>
                <input type="text" id="edtXnome" maxlength="60">
            </div>
            <div class="inline">
                <label for="cmbTipo">Tipo</label>
                <select id="cmbTipo">
                    <option value="1">Pessoa Física</option>
                    <option value="2" selected>Pessoa Jurídica</option>
                </select>
                <label for="edtIE">Insc. Est.</label>
                <input type="text" id="edtIE" maxlength="15" onkeyup="valIE(this)">
                <label for="edtCNPJ" id="lbl-freteCNPJ" >CNPJ</label>
                <input type="text" id="edtCNPJ" maxlength="18" onkeyup="valCNPJ(this)">
            </div>
            <div class="inline">
                <label for="edtXEnder">Endereço</label>
                <input type="text" id="edtXEnder" maxlength="60">
                <label for="edtUF">UF</label>
                <input type="text" id="edtUF" maxlength="2" style="max-width: 100px;">
            </div>
            <div class="inline">
                <label for="edtXmun">Município</label>
                <input type="text" id="edtXmun" maxlength="60">
            </div>
            <div class="inline">
                <label for="edtvServ">Valor Frete</label>
                <input type="text" id="edtvServ" maxlength="15" onkeyup="valFloat(this)">
                <label for="edtvBCRet">BC ICMS</label>
                <input type="text" id="edtvBCRet" maxlength="15" onkeyup="valFloat(this)">
                <label for="edtpICMSRet">Aliq. ICMS</label>
                <input type="text" id="edtpICMSRet" maxlength="5" onkeyup="valFloat(this)">
            </div>
            <div class="inline">
                <label for="edtvICMSRet">Aliq. ICMS</label>
                <input type="text" id="edtvICMSRet" maxlength="15" onkeyup="valFloat(this)">
                <label for="edtCFOP">CFOP</label>
                <input type="text" id="edtCFOP">
            </div>


            <div class="line">
                <button id="btnFrete">Salvar</button>
            </div>
        </div>           
        <div id="fatura" class="tab">
<!--                <h2>Faturamento</h2>-->
            <div id="W">

                <fieldset>
                    <legend>Dados de Fatura</legend>
                    <div class="inline">
                        <label>Valor da NF R$</label>
                        <input type="text" id="edtValorNF" value="0.00" onkeyup="valFloat(this)">
                        <label>Dias entre as Parcelas (separar por /)</label>
                        <input type="text" id="edtDiasParcelas" value="28">
                        <label>Desconto R$</label>
                        <input type="text" id="edtDesconto" value="0" onkeyup="valFloat(this)">
                    </div>
                    <div class="inline">
                        <label for="cmbModPag">Modo de Pgto.</label>
                        <select id="cmbModPag">
                            <option value="0">A Vista</option>
                            <option value="1" selected>A Prazo</option>
                        </select>
                        <label for="cmbTipPag">Tipo de Pgto.</label>
                        <select id="cmbTipPag">
                            <option value="01">Dinheiro</option>
                            <option value="02">Cheque</option>
                            <option value="03">Cartão de Crédito</option>
                            <option value="04">Cartão de Débito</option>
                            <option value="05">Crédito Loja</option>
                            <option value="10">Vale Alimentação</option>
                            <option value="11">Vale Refeição</option>
                            <option value="12">Vale Presente</option>
                            <option value="13">Vale Combustível</option>
                            <option value="14">Duplicata Mercantil</option>
                            <option value="15" selected>Boleto bancário</option>
                            <option value="90">Sem pagamento</option>
                            <option value="99">Outros</option>
                        </select>
                    </div>       
                    <input type="hidden" id="hdnPed">
                    <label class="inline">Texto Complementar</label>
                    <textarea  id="txaTextoCompl" rows="10"></textarea>                    
                </fieldset>

                <button id="btnGeraNFe">Gerar NFe</button>
            </div>
        </div>
        <div id="export" class="tab">
<!--                <h2>Arquivos TXT</h2>-->

                <fieldset>
                    <legend>TXT</legend>
                    <select id="txtFiles" size="20"></select>
                </fieldset>
                <fieldset>
                    <legend>PDF</legend>
                    <select id="pdfFiles" size="20"></select>
                </fieldset>
<!--                <button id="btnAssina">Assina XML</button>-->
        </div>                
    </div>   


</template>
<script>

    const pageData = main_data.fisc_nfe.data
    const pageFunc = main_data.fisc_nfe.func
    const pageScreen = document.querySelector('#card-fisc_nfe')

    pageData.NFe = new NFe('A,B,C,C02,C05,W,W02,X,Y,Y02,YA,YA01,Z')

/* CHAMADA DE FUNÇÕES INICIAL */    

    function startPage(){
        pageScreen.querySelector('#tab-emitente').click()
        pageScreen.querySelector('#edtIni').value =  today.iniMonth()
        pageScreen.querySelector('#edtFin').value =  today.finMonth()

        listNF('../NF/NFe/txt')
        listNF('../NF/NFe/pdf','pdf')
        fillEmitente()
        fillFiscal()
    }

/* FUNÇÔES */

    function fillEmitente(){
            const emitente = pageScreen.querySelector('#emitente')            
            emitente.querySelector('#xNome').value = pageData.NFe.C.xNome
            emitente.querySelector('#xFant').value = pageData.NFe.C.xFant
            emitente.querySelector('#IE').value = getIE(pageData.NFe.C.IE)
            emitente.querySelector('#IEST').value = pageData.NFe.C.IEST
            emitente.querySelector('#IM').value = pageData.NFe.C.IM
            emitente.querySelector('#CNAE').value = pageData.NFe.C.CNAE
            emitente.querySelector('#CRT').value = pageData.NFe.C.CRT
            emitente.querySelector('#CNPJ').value = getCNPJ(pageData.NFe.C02.CNPJ)
            emitente.querySelector('#xLgr').value = pageData.NFe.C05.xLgr
            emitente.querySelector('#nro').value = pageData.NFe.C05.nro
            emitente.querySelector('#bairro').value = pageData.NFe.C05.bairro
            emitente.querySelector('#cpl').value = pageData.NFe.C05.cpl
            emitente.querySelector('#xMun').value = pageData.NFe.C05.xMun
            emitente.querySelector('#cMun').value = pageData.NFe.C05.cMun
            emitente.querySelector('#UF').value = pageData.NFe.C05.UF
            emitente.querySelector('#xPais').value = pageData.NFe.C05.xPais
            emitente.querySelector('#cPais').value = pageData.NFe.C05.cPais
            emitente.querySelector('#CEP').value = getCEP(pageData.NFe.C05.CEP)
            emitente.querySelector('#fone').value = getFone(pageData.NFe.C05.fone)
    }

    function fillFiscal(){            
            const fiscal = pageScreen.querySelector('#fiscal')            
            fiscal.querySelector('#nNF').value = parseInt(pageData.NFe.B.nNF) + 1
            fiscal.querySelector('#cNF').value = pageData.NFe.B.cNF
            fiscal.querySelector('#cUF').value = pageData.NFe.B.cUF
            fiscal.querySelector('#natOp').value = pageData.NFe.B.natOp
            fiscal.querySelector('#mod').value = pageData.NFe.B.mod
            fiscal.querySelector('#serie').value = pageData.NFe.B.serie
            fiscal.querySelector('#dhEmi').value = today.getFormatDate()
            fiscal.querySelector('#dhSaiEnt').value = today.getFormatDate()
            fiscal.querySelector('#tpNF').value = pageData.NFe.B.tpNF
            fiscal.querySelector('#idDest').value = pageData.NFe.B.idDest
            fiscal.querySelector('#cMunFG').value = pageData.NFe.B.cMunFG
            fiscal.querySelector('#tpImp').value = pageData.NFe.B.tpImp
            fiscal.querySelector('#tpEmis').value = pageData.NFe.B.tpEmis
            fiscal.querySelector('#cDV').value = pageData.NFe.B.cDV
            fiscal.querySelector('#tpAmb').value = pageData.NFe.B.tpAmb
            fiscal.querySelector('#finNFe').value = pageData.NFe.B.finNFe
            fiscal.querySelector('#indFinal').value = pageData.NFe.B.indFinal
            fiscal.querySelector('#indPres').value = pageData.NFe.B.indPres
            fiscal.querySelector('#procEmi').value = pageData.NFe.B.procEmi
            fiscal.querySelector('#verProc').value = pageData.NFe.B.verProc
            fiscal.querySelector('#dhCont').value = pageData.NFe.B.dhCont
            fiscal.querySelector('#xJust').value = pageData.NFe.B.xJust
    }

    function fillCliente(){      
        const cliente = pageScreen.querySelector('#cliente')
        cliente.querySelector('#xNome').value = pageData.NFe.E.xNome
        cliente.querySelector('#indIEDest').value = pageData.NFe.E.indIEDest
        cliente.querySelector('#IE').value = getIE(pageData.NFe.E.IE)
        cliente.querySelector('#IM').value = pageData.NFe.E.IM
        cliente.querySelector('#CNPJ').value = getCNPJ(pageData.NFe.E02.CNPJ)
        cliente.querySelector('#xLgr').value = pageData.NFe.E05.xLgr
        cliente.querySelector('#nro').value = pageData.NFe.E05.nro
        cliente.querySelector('#XCpl').value = pageData.NFe.E05.xCpl
        cliente.querySelector('#xBairro').value = pageData.NFe.E05.xBairro
        cliente.querySelector('#xMun').value = pageData.NFe.E05.xMun
        cliente.querySelector('#cMun').value = pageData.NFe.E05.cMun
        cliente.querySelector('#UF').value = pageData.NFe.E05.UF
        cliente.querySelector('#CEP').value = getCEP(pageData.NFe.E05.CEP)
        cliente.querySelector('#cPais').value = pageData.NFe.E05.cPais
        cliente.querySelector('#xPais').value = pageData.NFe.E05.xPais
        cliente.querySelector('#fone').value = getFone(pageData.NFe.E05.fone)
    }

    function loadPed(){
        const query = getVal('nfe')
        const params = new Object;
            params.field = query[0]
            params.signal = query[1]
            params.value = query[2]
            params.dt_ini = pageScreen.querySelector('#edtIni').value
            params.dt_fin = pageScreen.querySelector('#edtFin').value
        const myPromisse = queryDB(params,'FIN-3');
        myPromisse.then((resolve)=>{            
            const json = JSON.parse(resolve)                   
            const tbl = pageScreen.querySelector('#tblBuscaPed')
            tbl.innerHTML = ''
            json.length > 0 ? tbl.head('Cod.|mobHide,Ped.,Data,Cliente.,Status|mobHide,Valor R$|mobHide') : 0
            for(let i=0; i<json.length;i++){
                tbl.plot(json[i],'id|mobHide,num_ped,data_ped,xFANT,status|mobHide,VALOR|mobHide','int,str,date,Upp,Upp,R$.',true)
            }   
        });
    }

    function loadItemPed(ped_id){
        const params = new Object;
                params.ped_id = ped_id
            const myPromisse = queryDB(params,'FIN-4');
            myPromisse.then((resolve)=>{
                const json = JSON.parse(resolve)       
                const tbl = pageScreen.querySelector('#tblItens')
                pageData.NFe.C.CRT = pageScreen.querySelector('#CRT').value

                if(tbl.rows.length > 0){
                    if (confirm(`Adicionar os ítens deste pedido a NFe atual?`)) {
                        pageScreen.querySelector('#hdnPed').value += ', '+ data.num_ped   
                    }else{
                        pageScreen.querySelector('#hdnPed').value = data.num_ped
                        tbl.head('Cod.|mobHide,Descrição,Qtd.,Preço Unit.,Sub Total,ICMS,%,CFOP')
                    }
                }else{
                    pageScreen.querySelector('#hdnPed').value = data.num_ped
                    tbl.head('Cod.|mobHide,Descrição,Qtd.,Preço Unit.,Sub Total,ICMS,%,CFOP')        
                }
                for(let i=0; i<json.length;i++){                        
                    json[i].CFOP = (pageData.NFe.C05.UF == pageData.NFe.E05.UF ? '51' : '61')+(json[i].id_emp == '13' ? '01' : '02')
                    json[i].ICMS = pageData.NFe.C.CRT == '3' ? json[i].pICMS : 0
                    json[i].TOT_ICMS = pageData.NFe.C.CRT == '3' ? json[i].vICMS : 0
                    tbl.plot(json[i],'cProd|mobHide,xProd,qTrib,vUnCom,vProd,TOT_ICMS,ICMS,CFOP','str,Upp,str,flo,flo,flo,flo,str')
                }

                pageFunc.somaNFeItens()
            })
    }

    function downloadFile(path){
        const link = document.createElement("a")
        link.download = path.split('/')[path.split('/').length-1]
        link.href = path
        document.body.appendChild(link)
        link.click()
        document.body.removeChild(link)
        delete link
    }

/* FUNÇÕES GLOBAIS */    

    pageFunc.somaNFeItens = ()=>{
        let total = 0
        const tbl = document.querySelector('#tblItens').rows
        pageData.NFe.itens = []
        for(let i=1; i<tbl.length; i++){
            pageData.NFe.addItem(tbl[i].data)
            const index = pageData.NFe.itens.length -1
//            pageData.NFe.itens[index].I.cProd = tbl[i].data.cProd
            const value = parseFloat(tbl[i].cells[4].innerHTML)
            total += value == NaN ? 0 : value
        }

        const txt_1 = `DOC. EMITIDO POR ME OU EPP OPTANTE S.NACIONAL, NÃO GERA DIREITO A CREDITO FISCAL DE ISSQN E IPI, PERMITE O APROVEITAMENTO DE CREDITO DO ICMS NO VALOR DE  R$${(total*0.0282).toFixed(2)} CORRESPONDENTE A ALIQUOTA DE 2,82% NOS TERMOS DO ARTIGO 23 DA LC 123. Aprovado conforme pedido(s) ${pageScreen.querySelector('#hdnPed').value}`
        const txt_2 = `DOC. GERA DIREITO A CREDITO FISCAL DO ICMS NO VALOR DE  R$${(total*0.18).toFixed(2)} CORRESPONDENTE A ALIQUOTA DE 18%. Aprovado conforme pedido(s) ${pageScreen.querySelector('#hdnPed').value}`
        pageScreen.querySelector('#txaTextoCompl').value =  pageData.NFe.C.CRT != '3' ? txt_1 : txt_2 
        pageScreen.querySelector('#edtValorNF').value = total.toFixed(2)
    }

/* CHAMADA DE FUNÇÕES DO DOM */    


 /***** PEDIDO *****/

    pageScreen.querySelector('#tblBuscaPed').addEventListener('click',(e)=>{
        data = e.target.parentNode.data
        data.mode = 'NFe'
        if (confirm(`Carregar Ped.${data.num_ped} de ${data.xFANT.toUpperCase()}?`)) {
            pageData.NFe.addCliente(data)
            .then(()=>{
                fillCliente()
                loadItemPed(data.id)
                pageScreen.querySelector('#tab-cliente').click()
            })
        }
    })

    pageScreen.querySelector('#btnBuscaPed').addEventListener('click',()=>{
        loadPed()         
    })

    pageScreen.querySelector('#tblItens').addEventListener('click',(e)=>{
        data = e.target.parentNode.data
        data.row = e.target.parentNode
        data.mode = 'edtItens'
        openHTML('fisc_nfeItens.html','pop-up','Edição de Ítem de NFe',data)
    })    

/***** FILES *****/    
    pageScreen.querySelector('#txtFiles').addEventListener('dblclick',()=>{
        downloadFile('../NF/NFe/txt/' + pageScreen.querySelector('#txtFiles').value)
    })

    pageScreen.querySelector('#pdfFiles').addEventListener('dblclick',()=>{
        downloadFile('../NF/NFe/pdf/' + pageScreen.querySelector('#pdfFiles').value)         
    })

/***** EMISSOR *****/

    pageScreen.querySelector('#btnSaveEmit').addEventListener('click',(event)=>{
        NFeConf(pageData.config)        
    })
                
/***** FISCAL *****/

    pageScreen.querySelector('#btnSaveFiscal').addEventListener('click',(event)=>{
        NFeConf(pageData.config)
    })

/***** CLIENTE *****/

    pageScreen.querySelector('#btnSaveCli').addEventListener('click',()=>{
        NFeConf(pageData.config)
    })

/***** FATURA *****/

    pageScreen.querySelector('#btnGeraNFe').addEventListener('click',()=>{
        pageData.NFe.geraChave()
        const txt = pageData.NFe.geraTXT()

/*        
        if(pageScreen.querySelector('#cliente').querySelector('#cMun').value.trim() != '' ){
            pageScreen.querySelector('#btnSaveFiscal').click()
            geraNFeItens()
            const txt = getTXT()
            const filename = 'NFe-'+(pageData.config.B.nNF).padStart(6,'0')
            uploadNFe(txt, filename)

        }else{
            alert('Favor verificar o campo código do município')
            pageScreen.querySelector('#tab-cliente').click()
            pageScreen.querySelector('#cliente').querySelector('#cMun').focus()
        }
*/
        console.log(txt)
    })

    pageScreen.querySelector('#btnBuscaIBGE').addEventListener('click',()=>{
        const cliente = pageScreen.querySelector('#cliente')
        const xMun = cliente.querySelector('#xMun')
        const cMun = cliente.querySelector('#cMun')
        const UF = cliente.querySelector('#UF')

        IBGE_cMun(xMun.value,UF.value).then((response)=>{
            const json = JSON.parse(response)
            for(let i=0; i<json.length; i++){
                if(json[i].nome.trim().toLowerCase() == xMun.value.trim().toLowerCase()){
                    xMun.value = json[i].nome
                    cMun.value = json[i].id
                    UF.value = UF.value.toUpperCase()
                    pageData.NFe.E05.xMun = json[i].nome
                    pageData.NFe.E05.cMun = json[i].id
                }
            }
        })
    })

/* INICIO */
    startPage()

</script>